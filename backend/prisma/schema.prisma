generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE SYSTEM TABLES
// ============================================

model Tenant {
  id            String         @id @default(uuid())
  name          String
  plan          String         @default("FREE")
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  email         String?
  phone         String?
  website       String?
  address       String?
  accountUrl    String?        @unique
  currency      String         @default("USD")
  language      String         @default("English")
  logo          String?
  
  // Relations
  branches      Branch[]
  categories    Category[]
  brands        Brand[]
  units         Unit[]
  customers     Customer[]
  suppliers     Supplier[]
  billers       Biller[]
  domains       Domain[]
  posOrders     POSOrder[]
  products      Product[]
  sales         Sale[]
  salesReturns  SalesReturn[]
  purchases     Purchase[]
  purchaseOrders PurchaseOrder[]
  quotations    Quotation[]
  invoices      Invoice[]
  settings      Setting[]
  subscriptions Subscription[]
  users         User[]
  warehouses    Warehouse[]
  employees     Employee[]
  departments   Department[]
  designations  Designation[]
  shifts        Shift[]
  holidays      Holiday[]
  leaveTypes    LeaveType[]
  accounts      Account[]
  expenseCategories ExpenseCategory[]
  incomeCategories  IncomeCategory[]
  expenses      Expense[]
  incomes       Income[]
  moneyTransfers MoneyTransfer[]
  warranties    Warranty[]
  variantAttributes VariantAttribute[]
  coupons       Coupon[]
  giftCards     GiftCard[]
  discountPlans DiscountPlan[]
  discounts     Discount[]
  tenantFeatures TenantFeature[]
  orders        Order[]
}

model Branch {
  id         String      @id @default(uuid())
  tenantId   String
  name       String
  city       String?
  address    String?
  phone      String?
  email      String?
  isActive   Boolean     @default(true)
  createdAt  DateTime    @default(now())
  
  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  posOrders  POSOrder[]
  sales      Sale[]
  salesReturns SalesReturn[]
  purchases  Purchase[]
  users      User[]
  warehouses Warehouse[]
  employees  Employee[]
  attendances Attendance[]
  orders     Order[]

  @@index([tenantId])
}

// ============================================
// USER & AUTHENTICATION TABLES
// ============================================

model User {
  id                       String     @id @default(uuid())
  tenantId                 String
  branchId                 String
  roleId                   String
  firstName                String?
  lastName                 String?
  email                    String     @unique
  password                 String
  phone                    String?
  avatar                   String?
  isActive                 Boolean    @default(true)
  emailVerified            Boolean    @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordResetToken       String?
  passwordResetExpires     DateTime?
  otp                      String?
  otpExpires               DateTime?
  lastLogin                DateTime?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt
  
  posOrders    POSOrder[]
  createdSales Sale[]     @relation("UserSales")
  branch       Branch     @relation(fields: [branchId], references: [id])
  role         Role       @relation(fields: [roleId], references: [id])
  tenant       Tenant     @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([branchId])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
}

model Role {
  id          String           @id @default(uuid())
  tenantId    String
  name        String
  description String?
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  permissions RolePermission[]
  users       User[]

  @@index([tenantId])
}

model Permission {
  id              String           @id @default(uuid())
  key             String           @unique
  name            String?
  module          String?
  description     String?
  
  rolePermissions RolePermission[]
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  
  permission   Permission @relation(fields: [permissionId], references: [id])
  role         Role       @relation(fields: [roleId], references: [id])

  @@unique([roleId, permissionId])
}

// ============================================
// PRODUCTS & INVENTORY TABLES
// ============================================

model Category {
  id          String    @id @default(uuid())
  tenantId    String
  parentId    String?
  name        String
  slug        String?
  description String?
  image       String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@index([tenantId])
  @@index([parentId])
}

model Brand {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  slug        String?
  description String?
  logo        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  products    Product[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Unit {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  shortName   String
  baseUnit    String?
  operator    String?   // multiply, divide
  operatorValue Decimal?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  products    Product[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Product {
  id              String          @id @default(uuid())
  tenantId        String
  categoryId      String
  brandId         String?
  unitId          String?
  name            String
  sku             String
  barcode         String?
  description     String?
  price           Decimal
  cost            Decimal?
  taxRate         Decimal         @default(0)
  minStock        Int             @default(0)
  maxStock        Int?
  weight          Decimal?
  dimensions      String?
  warrantyPeriod  Int?
  expiryDate      DateTime?
  image           String?
  isActive        Boolean         @default(true)
  isFeatured      Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  category        Category        @relation(fields: [categoryId], references: [id])
  brand           Brand?          @relation(fields: [brandId], references: [id])
  unit            Unit?           @relation(fields: [unitId], references: [id])
  tenant          Tenant          @relation(fields: [tenantId], references: [id])
  
  images          ProductImage[]
  variants        ProductVariant[]
  posItems        POSOrderItem[]
  saleItems       SaleItem[]
  saleReturnItems SalesReturnItem[]
  purchaseItems   PurchaseItem[]
  purchaseReturnItems PurchaseReturnItem[]
  quotationItems  QuotationItem[]
  invoiceItems    InvoiceItem[]
  stocks          Stock[]
  stockMoves      StockMovement[]
  orderItems      OrderItem[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([categoryId])
  @@index([brandId])
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  imageUrl  String
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductVariant {
  id              String   @id @default(uuid())
  productId       String
  name            String
  sku             String?
  barcode         String?
  price           Decimal?
  cost            Decimal?
  stock           Int      @default(0)
  attributes      Json?    // {"color": "red", "size": "L"}
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model Warranty {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  duration    Int      // Duration value
  period      String   // DAYS, WEEKS, MONTHS, YEARS
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name])
  @@index([tenantId])
}

model VariantAttribute {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // e.g., "Size (T-shirts)", "Color"
  values      String   // Comma-separated: "S,M,L,XL" or "Red,Blue,Green"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, name])
  @@index([tenantId])
}

// ============================================
// STOCK & WAREHOUSE TABLES
// ============================================

model Warehouse {
  id          String          @id @default(uuid())
  tenantId    String
  branchId    String
  name        String
  address     String?
  phone       String?
  email       String?
  isDefault   Boolean         @default(false)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  stocks      Stock[]
  movements   StockMovement[]
  stockTransfersFrom StockTransfer[] @relation("FromWarehouse")
  stockTransfersTo   StockTransfer[] @relation("ToWarehouse")
  branch      Branch          @relation(fields: [branchId], references: [id])
  tenant      Tenant          @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([branchId])
}

model Stock {
  id          String    @id @default(uuid())
  productId   String
  warehouseId String
  quantity    Int       @default(0)
  reservedQty Int       @default(0)
  updatedAt   DateTime  @updatedAt
  
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
}

model StockMovement {
  id          String    @id @default(uuid())
  productId   String
  warehouseId String
  type        String    // IN, OUT, ADJUSTMENT, TRANSFER
  quantity    Int
  refType     String?   // SALE, PURCHASE, RETURN, ADJUSTMENT, TRANSFER
  refId       String?
  note        String?
  createdBy   String?
  createdAt   DateTime  @default(now())
  
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([productId])
  @@index([warehouseId])
  @@index([refType, refId])
}

model StockTransfer {
  id              String    @id @default(uuid())
  fromWarehouseId String
  toWarehouseId   String
  status          String    @default("PENDING") // PENDING, COMPLETED, CANCELLED
  note            String?
  createdBy       String?
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  
  fromWarehouse   Warehouse @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouse     Warehouse @relation("ToWarehouse", fields: [toWarehouseId], references: [id])
  items           StockTransferItem[]

  @@index([fromWarehouseId])
  @@index([toWarehouseId])
}

model StockTransferItem {
  id              String        @id @default(uuid())
  stockTransferId String
  productId       String
  quantity        Int
  
  stockTransfer   StockTransfer @relation(fields: [stockTransferId], references: [id], onDelete: Cascade)

  @@index([stockTransferId])
}

model StockAdjustment {
  id          String    @id @default(uuid())
  warehouseId String
  type        String    // ADD, SUBTRACT
  reason      String?
  note        String?
  createdBy   String?
  createdAt   DateTime  @default(now())
  
  items       StockAdjustmentItem[]

  @@index([warehouseId])
}

model StockAdjustmentItem {
  id                String          @id @default(uuid())
  stockAdjustmentId String
  productId         String
  quantity          Int
  
  stockAdjustment   StockAdjustment @relation(fields: [stockAdjustmentId], references: [id], onDelete: Cascade)

  @@index([stockAdjustmentId])
}

// ============================================
// CUSTOMERS & SUPPLIERS TABLES
// ============================================

model Customer {
  id            String    @id @default(uuid())
  tenantId      String
  name          String
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  country       String?
  postalCode    String?
  taxNumber     String?
  creditLimit   Decimal?
  balance       Decimal   @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  sales         Sale[]
  salesReturns  SalesReturn[]
  quotations    Quotation[]
  invoices      Invoice[]
  giftCards     GiftCard[]
  orders        Order[]

  @@index([tenantId])
}

model Supplier {
  id            String    @id @default(uuid())
  tenantId      String
  name          String
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  country       String?
  postalCode    String?
  taxNumber     String?
  contactPerson String?
  balance       Decimal   @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  purchases     Purchase[]
  purchaseOrders PurchaseOrder[]
  purchaseReturns PurchaseReturn[]

  @@index([tenantId])
}

model Biller {
  id            String    @id @default(uuid())
  tenantId      String
  code          String
  firstName     String
  lastName      String
  companyName   String
  email         String?
  phone         String?
  address       String?
  city          String?
  state         String?
  country       String?
  postalCode    String?
  avatar        String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime @updatedAt
  
  tenant        Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
}

// ============================================
// POS TABLES
// ============================================

model POSOrder {
  id           String         @id @default(uuid())
  tenantId     String
  branchId     String
  cashierId    String
  customerId   String?
  orderNumber  String?
  subtotal     Decimal
  taxAmount    Decimal        @default(0)
  discount     Decimal        @default(0)
  total        Decimal
  paidAmount   Decimal        @default(0)
  changeAmount Decimal        @default(0)
  payment      String         // CASH, CARD, MIXED
  status       String         @default("COMPLETED")
  note         String?
  createdAt    DateTime       @default(now())
  
  branch       Branch         @relation(fields: [branchId], references: [id])
  cashier      User           @relation(fields: [cashierId], references: [id])
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  items        POSOrderItem[]
  sale         Sale?

  @@index([tenantId])
  @@index([branchId])
  @@index([orderNumber])
}

model POSOrderItem {
  id         String   @id @default(uuid())
  posOrderId String
  productId  String
  qty        Int
  price      Decimal
  discount   Decimal  @default(0)
  tax        Decimal  @default(0)
  total      Decimal
  
  posOrder   POSOrder @relation(fields: [posOrderId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])

  @@index([posOrderId])
}

// ============================================
// SALES TABLES
// ============================================

model Sale {
  id           String     @id @default(uuid())
  tenantId     String
  branchId     String
  posOrderId   String     @unique
  customerId   String?
  creatorId    String?
  invoiceNumber String?
  subtotal     Decimal
  taxAmount    Decimal    @default(0)
  discount     Decimal    @default(0)
  total        Decimal
  paidAmount   Decimal    @default(0)
  dueAmount    Decimal    @default(0)
  paymentStatus String    @default("PAID") // PAID, PARTIAL, UNPAID
  status       String     @default("COMPLETED") // COMPLETED, CANCELLED
  note         String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  branch       Branch     @relation(fields: [branchId], references: [id])
  creator      User?      @relation("UserSales", fields: [creatorId], references: [id])
  customer     Customer?  @relation(fields: [customerId], references: [id])
  pos          POSOrder   @relation(fields: [posOrderId], references: [id])
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  items        SaleItem[]
  returns      SalesReturn[]
  payments     SalePayment[]

  @@index([tenantId])
  @@index([invoiceNumber])
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  productId String
  qty       Int
  price     Decimal
  discount  Decimal @default(0)
  tax       Decimal @default(0)
  total     Decimal
  
  product   Product @relation(fields: [productId], references: [id])
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model SalePayment {
  id            String   @id @default(uuid())
  saleId        String
  amount        Decimal
  paymentMethod String
  reference     String?
  note          String?
  createdAt     DateTime @default(now())
  
  sale          Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
}

model SalesReturn {
  id           String            @id @default(uuid())
  tenantId     String
  branchId     String
  saleId       String
  customerId   String?
  returnNumber String?
  subtotal     Decimal
  taxAmount    Decimal           @default(0)
  total        Decimal
  reason       String?
  status       String            @default("COMPLETED")
  createdBy    String?
  createdAt    DateTime          @default(now())
  
  tenant       Tenant            @relation(fields: [tenantId], references: [id])
  branch       Branch            @relation(fields: [branchId], references: [id])
  sale         Sale              @relation(fields: [saleId], references: [id])
  customer     Customer?         @relation(fields: [customerId], references: [id])
  items        SalesReturnItem[]

  @@index([tenantId])
  @@index([saleId])
}

model SalesReturnItem {
  id            String      @id @default(uuid())
  salesReturnId String
  productId     String
  qty           Int
  price         Decimal
  total         Decimal
  
  salesReturn   SalesReturn @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)
  product       Product     @relation(fields: [productId], references: [id])

  @@index([salesReturnId])
}

// ============================================
// QUOTATION TABLES
// ============================================

model Quotation {
  id              String          @id @default(uuid())
  tenantId        String
  customerId      String?
  quotationNumber String?
  subtotal        Decimal
  taxAmount       Decimal         @default(0)
  discount        Decimal         @default(0)
  total           Decimal
  validUntil      DateTime?
  status          String          @default("DRAFT") // DRAFT, SENT, ACCEPTED, REJECTED, EXPIRED, CONVERTED
  note            String?
  terms           String?
  convertedToSale String?
  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  tenant          Tenant          @relation(fields: [tenantId], references: [id])
  customer        Customer?       @relation(fields: [customerId], references: [id])
  items           QuotationItem[]

  @@index([tenantId])
  @@index([quotationNumber])
}

model QuotationItem {
  id          String    @id @default(uuid())
  quotationId String
  productId   String
  qty         Int
  price       Decimal
  discount    Decimal   @default(0)
  tax         Decimal   @default(0)
  total       Decimal
  
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id])

  @@index([quotationId])
}

// ============================================
// INVOICE TABLES
// ============================================

model Invoice {
  id            String        @id @default(uuid())
  tenantId      String
  customerId    String?
  invoiceNumber String?
  saleId        String?
  subtotal      Decimal
  taxAmount     Decimal       @default(0)
  discount      Decimal       @default(0)
  total         Decimal
  paidAmount    Decimal       @default(0)
  dueAmount     Decimal       @default(0)
  dueDate       DateTime?
  status        String        @default("UNPAID") // UNPAID, PARTIAL, PAID, OVERDUE, CANCELLED
  note          String?
  terms         String?
  createdBy     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  customer      Customer?     @relation(fields: [customerId], references: [id])
  items         InvoiceItem[]
  payments      InvoicePayment[]

  @@index([tenantId])
  @@index([invoiceNumber])
}

model InvoiceItem {
  id        String  @id @default(uuid())
  invoiceId String
  productId String
  qty       Int
  price     Decimal
  discount  Decimal @default(0)
  tax       Decimal @default(0)
  total     Decimal
  
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@index([invoiceId])
}

model InvoicePayment {
  id            String   @id @default(uuid())
  invoiceId     String
  amount        Decimal
  paymentMethod String
  reference     String?
  note          String?
  createdAt     DateTime @default(now())
  
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ============================================
// PURCHASE TABLES
// ============================================

model Purchase {
  id              String         @id @default(uuid())
  tenantId        String
  branchId        String
  supplierId      String
  purchaseNumber  String?
  referenceNumber String?
  subtotal        Decimal
  taxAmount       Decimal        @default(0)
  discount        Decimal        @default(0)
  shippingCost    Decimal        @default(0)
  total           Decimal
  paidAmount      Decimal        @default(0)
  dueAmount       Decimal        @default(0)
  paymentStatus   String         @default("UNPAID") // PAID, PARTIAL, UNPAID
  status          String         @default("RECEIVED") // ORDERED, RECEIVED, CANCELLED
  note            String?
  receivedAt      DateTime?
  createdBy       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  branch          Branch         @relation(fields: [branchId], references: [id])
  supplier        Supplier       @relation(fields: [supplierId], references: [id])
  items           PurchaseItem[]
  returns         PurchaseReturn[]
  payments        PurchasePayment[]

  @@index([tenantId])
  @@index([supplierId])
  @@index([purchaseNumber])
}

model PurchaseItem {
  id          String   @id @default(uuid())
  purchaseId  String
  productId   String
  qty         Int
  receivedQty Int      @default(0)
  price       Decimal
  discount    Decimal  @default(0)
  tax         Decimal  @default(0)
  total       Decimal
  expiryDate  DateTime?
  
  purchase    Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([purchaseId])
}

model PurchasePayment {
  id            String   @id @default(uuid())
  purchaseId    String
  amount        Decimal
  paymentMethod String
  reference     String?
  note          String?
  createdAt     DateTime @default(now())
  
  purchase      Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  tenantId        String
  supplierId      String
  orderNumber     String?
  subtotal        Decimal
  taxAmount       Decimal             @default(0)
  discount        Decimal             @default(0)
  total           Decimal
  expectedDate    DateTime?
  status          String              @default("DRAFT") // DRAFT, SENT, PARTIAL, RECEIVED, CANCELLED
  note            String?
  createdBy       String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  tenant          Tenant              @relation(fields: [tenantId], references: [id])
  supplier        Supplier            @relation(fields: [supplierId], references: [id])
  items           PurchaseOrderItem[]

  @@index([tenantId])
  @@index([supplierId])
  @@index([orderNumber])
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  productId       String
  qty             Int
  receivedQty     Int           @default(0)
  price           Decimal
  total           Decimal
  
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
}

model PurchaseReturn {
  id              String               @id @default(uuid())
  tenantId        String
  purchaseId      String
  supplierId      String
  returnNumber    String?
  subtotal        Decimal
  taxAmount       Decimal              @default(0)
  total           Decimal
  reason          String?
  status          String               @default("COMPLETED")
  createdBy       String?
  createdAt       DateTime             @default(now())
  
  purchase        Purchase             @relation(fields: [purchaseId], references: [id])
  supplier        Supplier             @relation(fields: [supplierId], references: [id])
  items           PurchaseReturnItem[]

  @@index([purchaseId])
  @@index([supplierId])
}

model PurchaseReturnItem {
  id               String         @id @default(uuid())
  purchaseReturnId String
  productId        String
  qty              Int
  price            Decimal
  total            Decimal
  
  purchaseReturn   PurchaseReturn @relation(fields: [purchaseReturnId], references: [id], onDelete: Cascade)
  product          Product        @relation(fields: [productId], references: [id])

  @@index([purchaseReturnId])
}

// ============================================
// HRM TABLES
// ============================================

model Department {
  id          String       @id @default(uuid())
  tenantId    String
  name        String
  description String?
  managerId   String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  employees   Employee[]
  designations Designation[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Designation {
  id           String     @id @default(uuid())
  tenantId     String
  departmentId String?
  name         String
  description  String?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  department   Department? @relation(fields: [departmentId], references: [id])
  employees    Employee[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([departmentId])
}

model Shift {
  id          String     @id @default(uuid())
  tenantId    String
  name        String
  startTime   String     // "09:00"
  endTime     String     // "17:00"
  breakStart  String?
  breakEnd    String?
  workDays    String[]   // ["MON", "TUE", "WED", "THU", "FRI"]
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  employees   Employee[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Employee {
  id              String       @id @default(uuid())
  tenantId        String
  branchId        String?
  departmentId    String?
  designationId   String?
  shiftId         String?
  employeeId      String?      // Employee code
  firstName       String
  lastName        String
  email           String?
  phone           String?
  gender          String?
  dateOfBirth     DateTime?
  address         String?
  city            String?
  state           String?
  country         String?
  postalCode      String?
  joinDate        DateTime?
  endDate         DateTime?
  employmentType  String       @default("FULL_TIME") // FULL_TIME, PART_TIME, CONTRACT, INTERN
  salary          Decimal?
  salaryType      String       @default("MONTHLY") // HOURLY, DAILY, WEEKLY, MONTHLY, YEARLY
  bankName        String?
  bankAccount     String?
  taxNumber       String?
  emergencyContact String?
  emergencyPhone  String?
  avatar          String?
  documents       Json?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  branch          Branch?      @relation(fields: [branchId], references: [id])
  department      Department?  @relation(fields: [departmentId], references: [id])
  designation     Designation? @relation(fields: [designationId], references: [id])
  shift           Shift?       @relation(fields: [shiftId], references: [id])
  attendances     Attendance[]
  leaves          Leave[]
  payrolls        Payroll[]

  @@unique([tenantId, employeeId])
  @@index([tenantId])
  @@index([branchId])
  @@index([departmentId])
}

model Attendance {
  id          String    @id @default(uuid())
  employeeId  String
  branchId    String?
  date        DateTime  @db.Date
  clockIn     DateTime?
  clockOut    DateTime?
  breakStart  DateTime?
  breakEnd    DateTime?
  workHours   Decimal?
  overtime    Decimal?
  status      String    @default("PRESENT") // PRESENT, ABSENT, LATE, HALF_DAY, ON_LEAVE
  note        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  employee    Employee  @relation(fields: [employeeId], references: [id])
  branch      Branch?   @relation(fields: [branchId], references: [id])

  @@unique([employeeId, date])
  @@index([employeeId])
  @@index([date])
}

model LeaveType {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  daysAllowed Int      @default(0)
  isPaid      Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  leaves      Leave[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Leave {
  id          String    @id @default(uuid())
  employeeId  String
  leaveTypeId String
  startDate   DateTime  @db.Date
  endDate     DateTime  @db.Date
  days        Int
  reason      String?
  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  approvedBy  String?
  approvedAt  DateTime?
  rejectedBy  String?
  rejectedAt  DateTime?
  rejectReason String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  employee    Employee  @relation(fields: [employeeId], references: [id])
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@index([employeeId])
  @@index([status])
}

model Holiday {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  date        DateTime @db.Date
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([date])
}

model Payroll {
  id              String   @id @default(uuid())
  employeeId      String
  month           Int
  year            Int
  basicSalary     Decimal
  overtime        Decimal  @default(0)
  bonus           Decimal  @default(0)
  allowances      Decimal  @default(0)
  deductions      Decimal  @default(0)
  tax             Decimal  @default(0)
  netSalary       Decimal
  workDays        Int      @default(0)
  presentDays     Int      @default(0)
  absentDays      Int      @default(0)
  leaveDays       Int      @default(0)
  status          String   @default("DRAFT") // DRAFT, PROCESSED, PAID
  paidAt          DateTime?
  paymentMethod   String?
  note            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@index([employeeId])
  @@index([month, year])
}

// ============================================
// FINANCE & ACCOUNTING TABLES
// ============================================

model Account {
  id              String          @id @default(uuid())
  tenantId        String
  parentId        String?
  code            String
  name            String
  type            String          // ASSET, LIABILITY, EQUITY, INCOME, EXPENSE
  subType         String?         // BANK, CASH, RECEIVABLE, PAYABLE, etc.
  description     String?
  balance         Decimal         @default(0)
  isActive        Boolean         @default(true)
  isSystem        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  tenant          Tenant          @relation(fields: [tenantId], references: [id])
  parent          Account?        @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        Account[]       @relation("AccountHierarchy")
  journalEntries  JournalEntry[]
  expensesFrom    Expense[]       @relation("ExpenseFromAccount")
  incomesTo       Income[]        @relation("IncomeToAccount")
  transfersFrom   MoneyTransfer[] @relation("TransferFromAccount")
  transfersTo     MoneyTransfer[] @relation("TransferToAccount")

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([type])
}

model JournalEntry {
  id          String   @id @default(uuid())
  accountId   String
  date        DateTime @db.Date
  debit       Decimal  @default(0)
  credit      Decimal  @default(0)
  description String?
  refType     String?
  refId       String?
  createdBy   String?
  createdAt   DateTime @default(now())
  
  account     Account  @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([date])
  @@index([refType, refId])
}

model ExpenseCategory {
  id          String    @id @default(uuid())
  tenantId    String
  name        String
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  expenses    Expense[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Expense {
  id            String          @id @default(uuid())
  tenantId      String
  categoryId    String
  accountId     String
  amount        Decimal
  date          DateTime        @db.Date
  reference     String?
  description   String?
  attachment    String?
  status        String          @default("APPROVED") // PENDING, APPROVED, REJECTED
  approvedBy    String?
  createdBy     String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  tenant        Tenant          @relation(fields: [tenantId], references: [id])
  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  account       Account         @relation("ExpenseFromAccount", fields: [accountId], references: [id])

  @@index([tenantId])
  @@index([categoryId])
  @@index([date])
}

model IncomeCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  incomes     Income[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Income {
  id          String         @id @default(uuid())
  tenantId    String
  categoryId  String
  accountId   String
  amount      Decimal
  date        DateTime       @db.Date
  reference   String?
  description String?
  attachment  String?
  createdBy   String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  tenant      Tenant         @relation(fields: [tenantId], references: [id])
  category    IncomeCategory @relation(fields: [categoryId], references: [id])
  account     Account        @relation("IncomeToAccount", fields: [accountId], references: [id])

  @@index([tenantId])
  @@index([categoryId])
  @@index([date])
}

model MoneyTransfer {
  id            String   @id @default(uuid())
  tenantId      String
  fromAccountId String
  toAccountId   String
  amount        Decimal
  date          DateTime @db.Date
  reference     String?
  description   String?
  createdBy     String?
  createdAt     DateTime @default(now())
  
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  fromAccount   Account  @relation("TransferFromAccount", fields: [fromAccountId], references: [id])
  toAccount     Account  @relation("TransferToAccount", fields: [toAccountId], references: [id])

  @@index([tenantId])
  @@index([date])
}

// ============================================
// SETTINGS & CONFIGURATION TABLES
// ============================================

model Setting {
  id        String   @id @default(uuid())
  tenantId  String
  group     String   @default("general")
  key       String
  value     String
  type      String   @default("string") // string, number, boolean, json
  updatedAt DateTime @updatedAt
  
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, group, key])
  @@index([tenantId])
  @@index([group])
}

// ============================================
// PROMO TABLES
// ============================================

model Coupon {
  id          String    @id @default(uuid())
  tenantId   String
  name        String
  code        String
  description String?
  type        String    // FIXED, PERCENTAGE
  discount    Decimal   // Amount or percentage value
  limit       Int       @default(0) // 0 = unlimited
  validFrom   DateTime
  validTo     DateTime
  status      String    @default("ACTIVE") // ACTIVE, INACTIVE
  isAllProducts Boolean @default(true)
  oncePerCustomer Boolean @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  products    CouponProduct[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
}

model CouponProduct {
  id        String   @id @default(uuid())
  couponId String
  productId String
  
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([couponId, productId])
  @@index([couponId])
  @@index([productId])
}

model GiftCard {
  id          String    @id @default(uuid())
  tenantId   String
  code        String
  customerId  String?
  issuedDate  DateTime
  expiryDate  DateTime
  amount      Decimal
  balance     Decimal
  status      String    @default("ACTIVE") // ACTIVE, REDEEMED, EXPIRED, INACTIVE
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  customer    Customer? @relation(fields: [customerId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([customerId])
}

model DiscountPlan {
  id          String    @id @default(uuid())
  tenantId   String
  name        String
  customerGroup String  // All Customers, Members Only, High-Spending Customers, Online Customers, Students
  status      String    @default("ACTIVE") // ACTIVE, INACTIVE
  createdAt   DateTime  @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  discounts   Discount[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Discount {
  id            String    @id @default(uuid())
  tenantId     String
  discountPlanId String
  name          String
  value         Decimal
  type          String    // PERCENTAGE, FLAT
  validityStart DateTime
  validityEnd   DateTime
  days          String?   // Comma-separated: Mon,Tue,Wed,Thu,Fri,Sat,Sun
  isAllProducts Boolean   @default(true)
  status        String    @default("ACTIVE") // ACTIVE, INACTIVE, EXPIRED, REDEEMED
  createdAt     DateTime  @default(now())
  updatedAt     DateTime @updatedAt
  
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  discountPlan  DiscountPlan @relation(fields: [discountPlanId], references: [id])
  products      DiscountProduct[]

  @@index([tenantId])
  @@index([discountPlanId])
}

model DiscountProduct {
  id          String   @id @default(uuid())
  discountId  String
  productId   String
  
  discount    Discount @relation(fields: [discountId], references: [id], onDelete: Cascade)

  @@unique([discountId, productId])
  @@index([discountId])
  @@index([productId])
}

// ============================================
// FEATURE TOGGLE SYSTEM
// ============================================

model TenantFeature {
  id          String   @id @default(uuid())
  tenantId    String
  featureKey  String   // 'OMS', 'INVENTORY', etc.
  isEnabled   Boolean  @default(false)
  enabledAt   DateTime?
  enabledBy   String?  // super_admin_id
  disabledAt  DateTime?
  disabledBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, featureKey])
  @@index([tenantId])
  @@index([featureKey])
  @@index([tenantId, featureKey])
}

// ============================================
// ORDER MANAGEMENT SYSTEM (OMS)
// ============================================

model Order {
  id              String      @id @default(uuid())
  tenantId        String
  branchId        String?
  customerId      String?
  orderNumber     String      @unique
  status          String      @default("PENDING") // PENDING, CONFIRMED, PROCESSING, READY, DELIVERED, CANCELLED
  subtotal        Decimal
  taxAmount       Decimal     @default(0)
  discount        Decimal     @default(0)
  shippingCost    Decimal     @default(0)
  total           Decimal
  paymentStatus   String      @default("UNPAID") // UNPAID, PARTIAL, PAID
  paidAmount      Decimal     @default(0)
  dueAmount       Decimal     @default(0)
  deliveryAddress String?
  deliveryPhone   String?
  deliveryNotes   String?
  isDeliveryReady Boolean     @default(false)
  readyAt         DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  createdBy       String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  tenant          Tenant      @relation(fields: [tenantId], references: [id])
  branch          Branch?     @relation(fields: [branchId], references: [id])
  customer        Customer?   @relation(fields: [customerId], references: [id])
  items           OrderItem[]
  statusHistory   OrderStatus[]

  @@index([tenantId])
  @@index([branchId])
  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  productId   String
  productName String   // Denormalized for historical accuracy
  qty         Int
  price       Decimal
  discount    Decimal  @default(0)
  tax         Decimal  @default(0)
  total       Decimal
  createdAt   DateTime @default(now())
  
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model OrderStatus {
  id          String   @id @default(uuid())
  orderId     String
  status      String   // PENDING, CONFIRMED, PROCESSING, READY, DELIVERED, CANCELLED
  note        String?
  changedBy   String?
  createdAt   DateTime @default(now())
  
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// SUPER ADMIN TABLES
// ============================================

model Package {
  id            String         @id @default(uuid())
  name          String
  type          String
  price         Decimal
  discount      Decimal        @default(0)
  discountType  String?
  maxCustomers  Int?
  maxProducts   Int?
  maxInvoices   Int?
  maxSuppliers  Int?
  maxEmployees  Int?
  maxWarehouses Int?
  modules       String[]
  features      String[]
  isRecommended Boolean        @default(false)
  trialDays     Int            @default(0)
  position      Int            @default(0)
  status        String         @default("ACTIVE")
  description   String?
  image         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  subscriptions Subscription[]
}

model Subscription {
  id            String        @id @default(uuid())
  companyId     String
  packageId     String
  billingCycle  Int
  amount        Decimal
  paymentMethod String
  status        String        @default("PAID")
  startDate     DateTime      @default(now())
  expiryDate    DateTime
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  company       Tenant        @relation(fields: [companyId], references: [id])
  package       Package       @relation(fields: [packageId], references: [id])
  transactions  Transaction[]

  @@index([companyId])
  @@index([packageId])
}

model Domain {
  id        String   @id @default(uuid())
  companyId String
  domainUrl String   @unique
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  company   Tenant   @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model Transaction {
  id             String       @id @default(uuid())
  subscriptionId String
  invoiceId      String       @unique
  amount         Decimal
  paymentMethod  String
  status         String       @default("PAID")
  createdAt      DateTime     @default(now())
  
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
}
